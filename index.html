<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>121 → 180 Darts Practice</title>
<style>
body { font-family: system-ui, sans-serif; text-align:center; padding:20px; background:#e0e0e0; }
.big { font-size:2.2rem; margin:12px 0; }
.small { font-size:1.2rem; color:#555; }
input, button { font-size:1.6rem; padding:12px; margin:8px 0; width:90%; max-width:320px; }
button { background:#222; color:white; border:none; border-radius:6px; }
button:active { background:#444; }
/* added: small top-left button style */
.top-left { position: absolute; top: 12px; left: 12px; padding:8px 10px; font-size:1rem; width:auto; max-width:none; }
/* quick toggle button */
.quick-btn { background:#0b6; color:#042; font-weight:600; border:none; border-radius:6px; padding:8px 12px; min-width:80px; }
.quick-btn:active { filter:brightness(.9); }
/* updated: quick numeric replaced by toggleable quick panel */
.quick-panel { margin-top: 6px; display: grid; grid-template-columns: repeat(3, 64px); gap: 6px; justify-content: center; }
.quick-panel.hidden { display: none; }
.num-btn { width: 64px; margin: 0; padding: 8px; font-size: 1.2rem; border-radius: 6px; background: #444; color: #fff; border: 2px solid #fff; box-sizing: border-box; }
.num-btn:active { background: #666; border-color: #ddd; }
/* added: preset visit buttons */
.preset-row { margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
/* make preset buttons narrow despite the global button width:90% rule */
.preset-btn { width:auto; min-width:64px; padding:6px 10px; border-radius:6px; background:#0b6; color:#042; font-weight:600; border:none; font-size:1rem; }
.preset-btn:active { filter:brightness(.9); }
/* added: controls layout and bust/undo button colors */
.controls { display:flex; gap:10px; justify-content:center; align-items:center; flex-direction:column; }
.controls .sub { display:flex; gap:10px; }
.controls button { width:auto; min-width:120px; max-width:none; padding:10px 14px; }
.bust-btn { background:#c62828; color:white; }
.bust-btn:active { background:#e53935; }
.undo-btn { background:#6b6b6b; }
.undo-btn:active { background:#8a8a8a; }

/* new: input row so submit stays next to input */
.input-row { display:flex; gap:10px; justify-content:center; align-items:center; }
/* make input and submit share sizing so submit matches input height */
.input-row input { width:160px; max-width:40vw; margin:0; padding:12px; box-sizing:border-box; height:48px; font-size:1.6rem; }
/* new: tighter submit button override to avoid global 90% width and match height */
.input-row .submit-btn { width: auto !important; min-width:80px; padding:12px 10px; font-size:1.6rem; height:48px; box-sizing:border-box; }

/* keypad styles: tighter layout (updated to remove spacing between keys and presets) */
:root { --keypad-height: 280px; }
.key-row { display:flex; gap:0; justify-content:center; align-items:stretch; margin-top:10px; }
.preset-col { display:flex; flex-direction:column; gap:0; height:var(--keypad-height); }
/* make preset buttons match keypad key height and remove margins so columns sit flush */
.preset-col .preset-btn { width:88px; padding:0; height:calc(var(--keypad-height) / 5); line-height:calc(var(--keypad-height) / 5); text-align:center; margin:0; border-radius:6px; box-sizing:border-box; }
.key-area { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0; margin-top:0; height:var(--keypad-height); }
.keypad { display:flex; flex-direction:column; gap:0; justify-content:center; height:100%; }
/* distribute the keypad into 4 equal rows (3 rows of numbers + bottom row) so they fill the key-area */
.keypad-grid { display:grid; grid-template-columns: repeat(3, 56px); gap:0; justify-content:center; grid-auto-rows: calc(var(--keypad-height) / 4); }
.key-btn { width:56px; /* remove fixed height and let the grid row size it */ border-radius:6px; background:#333; color:white; border:2px solid #fff; font-size:1.1rem; margin:0; padding:0; box-sizing:border-box; height:100%; display:flex; align-items:center; justify-content:center; }
.key-btn:active { background:#555; border-color:#ddd; }
.key-action { background:#888; color:#fff; margin:0; padding:0; }
.key-enter { background:#0a84ff; color:#fff; grid-column:span 3; height:100%; margin:0; padding:0; }
/* override global button margins inside the keypad area */
.key-row button, .key-row input, .preset-col button { margin:0; }
/* smaller inline status message */
.status { font-size:1rem; color:#333; margin:8px 0; min-height:1.2rem; }
</style>
</head>
<body>

<!-- added: Set start button in the top-left -->
<button class="top-left" onclick="setStartingNumber()">Set start</button>

<div class="big">Target: <span id="target">121</span></div>
<!-- <div class="big">Score: <span id="score">0</span></div> -->
<div class="small">Remaining this attempt:</div>
<div class="big"><span id="remaining">121</span></div>
<div class="small">Visits at this target: <span id="visits">0</span></div>
<div class="small">Consecutive 9-dart misses: <span id="consecMisses">0</span></div>
<!-- moved: smaller status area placed here between consec misses and the input -->
<div id="status" class="status"></div>

<!-- changed: input + submit sit side-by-side; bust and undo underneath -->
<div class="input-row">
  <input id="visit" type="text" readonly inputmode="none" placeholder="3-dart total"/>
  <button class="submit-btn" onclick="submitVisit()">Submit</button>
</div>
<div class="controls">
  <div class="sub">
    <button class="bust-btn" onclick="bustVisit()">Bust</button>
    <button class="undo-btn" onclick="undo()">Undo</button>
    <!-- added: Quick button to toggle quick numeric panel -->
    <button class="quick-btn" onclick="toggleQuickPanel()">
      <!-- changed: icon inline SVG for quick access button -->
      Quick
    </button>
  </div>
</div>

<!-- quick numeric buttons (hidden by default) -->
<div id="quickPanel" class="quick-panel hidden">
  <button class="num-btn" onclick="submitVisit(1); toggleQuickPanel(false)">1</button>
  <button class="num-btn" onclick="submitVisit(2); toggleQuickPanel(false)">2</button>
  <button class="num-btn" onclick="submitVisit(3); toggleQuickPanel(false)">3</button>
  <button class="num-btn" onclick="submitVisit(4); toggleQuickPanel(false)">4</button>
  <button class="num-btn" onclick="submitVisit(5); toggleQuickPanel(false)">5</button>
  <button class="num-btn" onclick="submitVisit(6); toggleQuickPanel(false)">6</button>
  <button class="num-btn" onclick="submitVisit(7); toggleQuickPanel(false)">7</button>
  <button class="num-btn" onclick="submitVisit(8); toggleQuickPanel(false)">8</button>
  <button class="num-btn" onclick="submitVisit(9); toggleQuickPanel(false)">9</button>
</div>

<!-- keypad with presets left and right -->
<div class="key-row">
  <div class="preset-col">
    <button class="preset-btn" onclick="autoSubmitVisit(26)">26</button>
    <button class="preset-btn" onclick="autoSubmitVisit(40)">40</button>
    <button class="preset-btn" onclick="autoSubmitVisit(41)">41</button>
    <button class="preset-btn" onclick="autoSubmitVisit(45)">45</button>
    <button class="preset-btn" onclick="autoSubmitVisit(57)">57</button>
  </div>

  <div class="key-area">
    <div class="keypad">
      <div class="keypad-grid">
        <button class="key-btn" onclick="keypadPress('7')">7</button>
        <button class="key-btn" onclick="keypadPress('8')">8</button>
        <button class="key-btn" onclick="keypadPress('9')">9</button>
        <button class="key-btn" onclick="keypadPress('4')">4</button>
        <button class="key-btn" onclick="keypadPress('5')">5</button>
        <button class="key-btn" onclick="keypadPress('6')">6</button>
        <button class="key-btn" onclick="keypadPress('1')">1</button>
        <button class="key-btn" onclick="keypadPress('2')">2</button>
        <button class="key-btn" onclick="keypadPress('3')">3</button>
      </div>
      <div class="keypad-grid">
        <button class="key-btn key-action" onclick="keypadClear()">C</button>
        <button class="key-btn" onclick="keypadPress('0')">0</button>
        <button class="key-btn key-action" onclick="keypadBackspace()">←</button>
      </div>
    </div>
  </div>

  <div class="preset-col">
    <button class="preset-btn" onclick="autoSubmitVisit(60)">60</button>
    <button class="preset-btn" onclick="autoSubmitVisit(95)">95</button>
    <button class="preset-btn" onclick="autoSubmitVisit(100)">100</button>
    <button class="preset-btn" onclick="autoSubmitVisit(140)">140</button>
    <button class="preset-btn" onclick="autoSubmitVisit(180)">180</button>
  </div>
</div>

<script>
let game = {
  target: 121,
  score: 0,
  currentRemaining: 121,
  visitsAtTarget: 0,
  consecutive9Misses: 0
};

// values that cannot be finished with a single dart (require setup/double on final dart rules)
const invalidSingleFinishes = [23,29,31,35,37,41,43,44,46,47,49,52,53,55,56,58,59];

const remainingEl = document.getElementById("remaining");
const targetEl = document.getElementById("target");
// const scoreEl = document.getElementById("score");
const statusEl = document.getElementById("status");
const visitsEl = document.getElementById("visits");
const consecMissesEl = document.getElementById("consecMisses");
const visitInput = document.getElementById("visit");

// added: handler to prompt for a starting number and reset game state
function setStartingNumber() {
  let val = prompt("Enter starting target:", String(game.target));
  if (val === null) return; // cancelled
  val = Number(val);
  if (!Number.isFinite(val) || val <= 0) {
    alert("Please enter a positive number");
    return;
  }
  pushState();
  game.target = Math.floor(val);
  game.currentRemaining = game.target;
  game.score = 0;
  game.visitsAtTarget = 0;
  game.consecutive9Misses = 0;
  updateUI(`Starting target set to ${game.target}`);
}

function submitVisit(quickSetValue = null) {
  let dartsUsed;
  let increment;
  if (quickSetValue !== null) {
    // Disallow a '1-dart' quick success on remaining scores that cannot be finished with 1 dart
    if (quickSetValue === 1 && (invalidSingleFinishes.includes(game.currentRemaining) || (game.currentRemaining > 60))) {
      updateUI(`Cannot finish ${game.currentRemaining} with 1 dart.`);
      return;
    }

    pushState();
    dartsUsed = (3 * game.visitsAtTarget) + quickSetValue;
    increment = 10 - dartsUsed;
    game.score += increment;
    game.target += increment;
    game.currentRemaining = game.target;

    // Reset counters
    game.visitsAtTarget = 0;
    game.consecutive9Misses = 0;

    updateUI(`HIT! Score +${increment}, target now ${game.target}`);
    return;
  }
  let visit = Number(visitInput.value);
  visitInput.value = "";
  if (!Number.isFinite(visit) || visit < 0) return;

  pushState();
  game.visitsAtTarget++;

  // Exact hit
  if (visit === game.currentRemaining) {
    // Restore original prompt behavior for darts used
    dartsUsed = prompt("You hit the target! How many darts did it take? (1–9)", "3");
    dartsUsed = Number(dartsUsed);
    if (!Number.isFinite(dartsUsed) || dartsUsed < 1) dartsUsed = 1;

    if (dartsUsed > 9) dartsUsed = 9;


    // Disallow declaring a hit when dartsUsed is 4 or 7 for certain impossible single-dart finishes
    if (([1, 4, 7].includes(dartsUsed)) && (invalidSingleFinishes.includes(game.currentRemaining) || (game.currentRemaining > 60 && dartsUsed === 1))) {
      // revert the pushed state (we called pushState earlier) by restoring last snapshot
      if (history && history.length > 0) {
        const prev = history.pop();
        game = prev;
      }
      updateUI(`Cannot finish ${game.currentRemaining} with ${dartsUsed} darts`);
      return;
    }

    increment = 10 - dartsUsed;
    game.score += increment;
    game.target += increment;
    game.currentRemaining = game.target;

    // Reset counters
    game.visitsAtTarget = 0;
    game.consecutive9Misses = 0;

    updateUI(`HIT! Score +${increment}, target now ${game.target}`);
    return;
  }

  if (visit > game.currentRemaining) {
    // Bust (over-hit)
    game.currentRemaining -= 0; // Remain unchanged as per original rules
    updateUI(`Bust! Missed the target, remaining reset to target`);
  } else {
    // Normal miss (under-hit)
    game.currentRemaining -= visit;
    updateUI(`Next visit, remaining: ${game.currentRemaining}`);
  }

  

  // After 3 visits (1 9-dart attempt) without hitting target
  if (game.visitsAtTarget >= 3) {
    game.consecutive9Misses++;
    game.visitsAtTarget = 0;
    game.currentRemaining = game.target;
    updateUI(`9-dart attempt missed, remaining reset to target ${game.target}`);

    // Trigger penalty prompt only after 3 consecutive 9-dart misses
    if (game.consecutive9Misses >= 3) {
      const takeShot = confirm("3 consecutive 9-dart attempts missed! Take shot?\nOK = take shot\nCancel = decrease 1");
      if (!takeShot) {
        game.target--;
        game.currentRemaining = game.target;
        updateUI(`Target decreased by 1! New target: ${game.target}`);
      }
    }
  }
}

// added: handler for explicit Bust button (counts as a visit and applies 3-visit logic)
function bustVisit() {
  pushState();
  game.visitsAtTarget++;
  game.currentRemaining -= 0; // Remain unchanged as per original rules
  updateUI(`Bust! Missed the target, remaining reset to target`);

  if (game.visitsAtTarget >= 3) {
    game.consecutive9Misses++;
    game.visitsAtTarget = 0;
    game.currentRemaining = game.target;
    updateUI(`9-dart attempt missed, remaining reset to target ${game.target}`);

    if (game.consecutive9Misses >= 3) {
      const takeShot = confirm("3 consecutive 9-dart attempts missed! Take shot?\nOK = take shot\nCancel = decrease 1");
      if (!takeShot) {
        game.target--;
        game.currentRemaining = game.target;
        updateUI(`Target decreased by 1! New target: ${game.target}`);
      }
    }
  }
}

let history = [];
function pushState() {
  // store a deep copy of the game state
  history.push(JSON.parse(JSON.stringify(game)));
  // optional cap
  if (history.length > 50) history.shift();
}

function undo() {
  if (history.length === 0) {
    updateUI('Nothing to undo');
    return;
  }
  const prev = history.pop();
  // replace game object properties
  game = prev;
  updateUI('Undid last action');
}

function updateUI(status="") {
  targetEl.textContent = game.target;
  // scoreEl.textContent = game.score;
  remainingEl.textContent = game.currentRemaining;
  visitsEl.textContent = game.visitsAtTarget;
  consecMissesEl.textContent = game.consecutive9Misses;
  statusEl.textContent = status;
}

// helper to auto-fill the visit input and submit
function autoSubmitVisit(value) {
  visitInput.value = String(value);
  submitVisit();
}

// keypad handlers
function keypadPress(d) {
  // Append digit but prevent leading zeros and overly long numbers
  let cur = String(visitInput.value || "");
  if (cur === "0") cur = "";
  if (cur.length >= 4) return; // limit to 4 digits
  visitInput.value = cur + d;
}
function keypadBackspace() {
  visitInput.value = String(visitInput.value || "").slice(0, -1);
}
function keypadClear() {
  visitInput.value = "";
}

// add toggle function for quick panel
function toggleQuickPanel(force) {
  const panel = document.getElementById('quickPanel');
  if (!panel) return;
  if (force === true) panel.classList.remove('hidden');
  else if (force === false) panel.classList.add('hidden');
  else panel.classList.toggle('hidden');
}

// Initial render
updateUI();
</script>

</body>
</html>

